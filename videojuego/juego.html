<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <title>Juego</title>
  <style>
    .altura { height: 60px; }

    body {
      display: block;
      justify-items: center;
      background-image: url('./imagenes/el-bueno.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #grid {
      margin: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .bordered { border: 2px solid rgb(200, 200, 200); }
    .backgrounded, .bordered { border: none; background: transparent; }

    .player {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-image: url('./imagenes/pato.png');
    }

    .player.down { background-image: url('./imagenes/patoabj.png'); }
    .player.up { background-image: url('./imagenes/patoarriba.png'); }
    .player.left { background-image: url('./imagenes/patoizq.png'); }
    .player.right { background-image: url('./imagenes/pato.png'); }

    .crumb {
      width: 22px;
      height: 22px;
      background: radial-gradient(circle at 30% 30%, hsl(44, 31%, 54%) 0%, #5f4d03 40%, #a7ad5a 100%);
      border-radius: 50%;
      margin: 4px auto;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .explosion {
      position: absolute;
      width: 80px;
      height: 80px;
      background-image: url('./imagenes/explosion.gif');
      background-size: cover;
      pointer-events: none;
      z-index: 10;
    }

    .pollo {
      background-image: url('./imagenes/pollon.png') !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
    }

    .aguila {
      position: absolute;
      width: 70px;
      height: 70px;
      background-image: url('./imagenes/aguila.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transform: scaleX(-1);
      z-index: 15;
      pointer-events: none;
    }

    #winPopup, #losePopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }

    .popup-content {
      background: white;
      padding: 30px 50px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-size: 24px;
    }

    button {
      margin-top: 20px;
      padding: 10px 25px;
      font-size: 18px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="hud" style="margin:8px 0;font-weight:600; font-size: 40px; display: flex; justify-content: center;">
    Puntos: &nbsp;<span id="score">0</span>
  </div>

  <div class="container" id="grid"></div>

  <div style="display: flex; justify-content: center; margin-top: 20px;">
    <button id="iniciar">Jugar con voz!</button>
    <button id="detener">Jugar sin voz</button>
  </div>

  <div id="winPopup">
    <div class="popup-content">
      <p>¬°Ganaste! üèÜ</p>
      <button onclick="location.reload()">Volver a jugar</button>
    </div>
  </div>

  <div id="losePopup">
    <div class="popup-content">
      <p>¬°Perdiste! üò¢</p>
      <button onclick="location.reload()">Volver a jugar</button>
    </div>
  </div>

  <!-- Audios -->
  <audio autoplay loop>
    <source src="../sonidos/musica-fondo.mp3" type="audio/mpeg">
  </audio>
  <audio id="moveSound" src="../sonidos/Cuackcorto.mp3" preload="auto"></audio>
  <audio id="winSound" src="../sonidos/victoria.mp3" preload="auto"></audio>
  <audio id="tronarSound" src="../sonidos/explosion.mp3" preload="auto"></audio>
  <audio id="aguilaSound" src="../sonidos/aguila.mp3" preload="auto"></audio>
  <audio id="alertaSound" loop src="../sonidos/alerta.mp3" preload="auto"></audio>
  <audio id="aguilaSalida" src="../sonidos/salida.mp3" preload="auto"></audio>
  <audio id="derrotaSound" src="../sonidos/derrota.mp3" preload="auto"></audio>
  <audio id="eatSound" src="../sonidos/clear-combo.mp3" preload="auto"></audio>

<script>
  const gridHeight = 10, gridWidth = 12;
  let score = 0;
  let crumb = null;
  let gameWon = false; // ‚Üê bandera de victoria

  window.addEventListener('load', () => {
    const grid = document.getElementById("grid");
    for (let y = 0; y < gridHeight; y++) {
      const row = document.createElement("div");
      row.className = 'row altura';
      for (let x = 0; x < gridWidth; x++) {
        const cell = document.createElement("div");
        cell.className = 'col-1 backgrounded bordered';
        cell.id = `cell-${y}-${x}`;
        cell.style.position = "relative";
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }
    document.getElementById("cell-5-6").classList.add("player");
    spawnCrumb();
    setTimeout(aparecerAguila, 1000);
  });

  document.addEventListener('keydown', handleKeydown);

  function handleKeydown(event) {
    if (gameWon) return; // ‚Üê no mover despu√©s de ganar
    const player = document.querySelector(".player");
    if (!player || player.classList.contains("pollo")) return;

    const [_, y, x] = player.id.split('-');
    let nextY = parseInt(y), nextX = parseInt(x), dir = '';
    switch (event.key) {
      case 'ArrowUp': nextY--; dir = 'up'; break;
      case 'ArrowDown': nextY++; dir = 'down'; break;
      case 'ArrowLeft': nextX--; dir = 'left'; break;
      case 'ArrowRight': nextX++; dir = 'right'; break;
      default: return;
    }

    if (nextX >= 0 && nextX < gridWidth && nextY >= 0 && nextY < gridHeight) {
      const nextCell = document.getElementById(`cell-${nextY}-${nextX}`);
      player.className = player.className.replace(/\bplayer\b.*$/, '');
      nextCell.classList.add('player', dir);
      const moveSound = document.getElementById('moveSound');
      moveSound.currentTime = 0; moveSound.play();
      checkCrumbCollision();
    }
  }

  // --- Migaja ---
  function spawnCrumb() {
    if (crumb) crumb.remove();
    let y, x;
    do {
      y = Math.floor(Math.random() * gridHeight);
      x = Math.floor(Math.random() * gridWidth);
    } while (document.getElementById(`cell-${y}-${x}`).classList.contains('player'));

    const cell = document.getElementById(`cell-${y}-${x}`);
    const newCrumb = document.createElement("div");
    newCrumb.className = "crumb";
    cell.appendChild(newCrumb);
    crumb = newCrumb;
  }

  function checkCrumbCollision() {
    const player = document.querySelector('.player');
    if (!player || !crumb) return;

    if (player.contains(crumb)) {
      const eatSound = document.getElementById('eatSound');
      eatSound.currentTime = 0;
      eatSound.play();

      score++;
      document.getElementById('score').textContent = score;
      crumb.remove();
      crumb = null;

      if (score >= 10) {
        winGame();
      } else {
        spawnCrumb();
      }
    }
  }

function winGame() {
  document.removeEventListener('keydown', handleKeydown);
  const player = document.querySelector('.player');
  if (!player) return;

  // Evita que el √°guila siga apareciendo
  gameWon = true;

  const grid = document.getElementById('grid');
  const explosion = document.createElement('div');
  explosion.className = 'explosion';
  grid.appendChild(explosion);

  // Calcula posici√≥n exacta del pato dentro del grid
  const rect = player.getBoundingClientRect();
  const gridRect = grid.getBoundingClientRect();
  explosion.style.top = (rect.top - gridRect.top - 20) + 'px';
  explosion.style.left = (rect.left - gridRect.left - 20) + 'px';

  const tronar = document.getElementById('tronarSound');
  tronar.currentTime = 0;
  tronar.play();

  // Despu√©s de la explosi√≥n: el pato se transforma en pollo, en el mismo lugar
  setTimeout(() => {
    explosion.remove();

    // ‚úÖ Mantener la clase "player" y a√±adir "pollo"
    player.classList.add('pollo');

    // Reproducir sonido y mostrar popup
    const winSound = document.getElementById('winSound');
    winSound.currentTime = 0;
    winSound.play();

    document.getElementById('winPopup').style.display = 'flex';
  }, 1000);
}

  // --- √Åguila ---

  function aparecerAguila() {
    if (gameWon) return; // ‚Üê no aparece si ya se gan√≥

    const grid = document.getElementById('grid');
    const fila = Math.floor(Math.random() * gridHeight);
    const aguila = document.createElement('div');
    aguila.className = 'aguila';
    grid.appendChild(aguila);

    const rowHeight = document.querySelector('.altura').offsetHeight;
    let left = grid.offsetWidth + 70;
    aguila.style.top = (fila * rowHeight) + 'px';
    aguila.style.left = left + 'px';

    const aguilaSound = document.getElementById('aguilaSound');
    aguilaSound.currentTime = 0;
    aguilaSound.play();

    const alertSound = document.getElementById('alertaSound');
    const derrotaSound = document.getElementById('derrotaSound');
    const aguilaSalida = document.getElementById('aguilaSalida');

    const step = 8;
    const interval = setInterval(() => {
      if (gameWon) { // ‚Üê detiene movimiento si se gan√≥
        clearInterval(interval);
        aguila.remove();
        return;
      }

      left -= step;
      aguila.style.left = left + 'px';

      const player = document.querySelector('.player');
      if (player) {
        const py = parseInt(player.id.split('-')[1]);
        if (py === fila) {
          if (alertSound.paused) { alertSound.currentTime = 0; alertSound.play(); }
        } else if (!alertSound.paused) alertSound.pause();

        const playerRect = player.getBoundingClientRect();
        const aguilaRect = aguila.getBoundingClientRect();
        if (
          playerRect.left < aguilaRect.right &&
          playerRect.right > aguilaRect.left &&
          playerRect.top < aguilaRect.bottom &&
          playerRect.bottom > aguilaRect.top
        ) {
          clearInterval(interval);
          if (!alertSound.paused) alertSound.pause();
          derrotaSound.currentTime = 0; derrotaSound.play();
          aguila.remove();
          mostrarPopupPerder();
        }
      }

      if (left < -100) {
        clearInterval(interval);
        if (!alertSound.paused) alertSound.pause();
        aguilaSalida.currentTime = 0; aguilaSalida.play();
        aguila.remove();
        if (!gameWon) setTimeout(aparecerAguila, 3000);
      }
    }, 60);
  }

  function mostrarPopupPerder() {
    document.removeEventListener('keydown', handleKeydown);
    document.getElementById('losePopup').style.display = 'flex';
  }

  // --- VOZ ---
const iniciarBtn = document.getElementById('iniciar');
const detenerBtn = document.getElementById('detener');
let reconocimiento = null;
let reconocimientoActivo = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  reconocimiento = new SpeechRecognition();
  reconocimiento.lang = 'es-MX'; // espa√±ol latinoamericano
  reconocimiento.continuous = true; // sigue escuchando sin reiniciar
  reconocimiento.interimResults = false; // solo resultados finales

  // Al iniciar la detecci√≥n de voz
  iniciarBtn.onclick = () => {
    if (!reconocimientoActivo) {
      reconocimiento.start();
      reconocimientoActivo = true;
      iniciarBtn.disabled = true;
      detenerBtn.disabled = false;
      console.log("üé§ Reconocimiento de voz iniciado");
    }
  };

  // Al detener la detecci√≥n de voz
  detenerBtn.onclick = () => {
    if (reconocimientoActivo) {
      reconocimiento.stop();
      reconocimientoActivo = false;
      iniciarBtn.disabled = false;
      detenerBtn.disabled = true;
      console.log("üõë Reconocimiento de voz detenido");
    }
  };

  // Procesar los resultados reconocidos
  reconocimiento.onresult = (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        transcript += event.results[i][0].transcript.trim().toLowerCase();
      }
    }

    if (transcript) {
      console.log("üó£Ô∏è Comando detectado:", transcript);
      if (transcript.includes("arriba")) simularTecla("ArrowUp");
      else if (transcript.includes("abajo")) simularTecla("ArrowDown");
      else if (transcript.includes("izquierda")) simularTecla("ArrowLeft");
      else if (transcript.includes("derecha")) simularTecla("ArrowRight");
    }
  };

  // No reiniciar autom√°ticamente el reconocimiento
  reconocimiento.onend = () => {
    if (reconocimientoActivo) {
      console.log("Reconocimiento finaliz√≥ inesperadamente, reiniciando...");
      reconocimiento.start(); // se reinicia solo si el usuario no lo detuvo
    }
  };

  reconocimiento.onerror = (event) => {
    console.warn("‚ö†Ô∏è Error de reconocimiento:", event.error);
  };

} else {
  alert("Tu navegador no soporta reconocimiento de voz üò¢");
}

// Simular las teclas para compatibilidad con el sistema de movimiento actual
function simularTecla(tecla) {
  const e = new KeyboardEvent("keydown", { key: tecla });
  document.dispatchEvent(e);
}

</script>
</body>
</html>