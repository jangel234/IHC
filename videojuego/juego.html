<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <title>Juego</title>
  <style>
    .altura { height: 60px; }

    body {
      display: block;
      justify-items: center;
      background-image: url('./imagenes/el-bueno.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    #grid {
      margin: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .bordered { border: 2px solid rgb(200, 200, 200); }
    .backgrounded, .bordered { border: none; background: transparent; }

    .player {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-image: url('./imagenes/pato.png');
    }

    .player.down { background-image: url('./imagenes/patoabj.png'); }
    .player.up { background-image: url('./imagenes/patoarriba.png'); }
    .player.left { background-image: url('./imagenes/patoizq.png'); }
    .player.right { background-image: url('./imagenes/pato.png'); }

    .crumb {
      width: 22px;
      height: 22px;
      background: radial-gradient(circle at 30% 30%, hsl(44, 31%, 54%) 0%, #5f4d03 40%, #a7ad5a 100%);
      border-radius: 50%;
      margin: 4px auto;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .explosion {
      position: absolute;
      width: 80px;
      height: 80px;
      background-image: url('./imagenes/explosion.gif');
      background-size: cover;
      pointer-events: none;
      z-index: 10;
    }

    .pollo {
      background-image: url('./imagenes/pollon.png') !important;
      background-size: contain !important;
      background-repeat: no-repeat !important;
      background-position: center !important;
    }

    .aguila {
      position: absolute;
      width: 60px;
      height: 60px;
      background-image: url('./imagenes/aguila.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transform: scaleX(-1);
      z-index: 15;
      pointer-events: none;
    }

    #winPopup, #losePopup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }

    .popup-content {
      background: white;
      padding: 30px 50px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-size: 24px;
    }

    button {
      margin-top: 20px;
      padding: 10px 25px;
      font-size: 18px;
      background: #000000;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .modo-activo {
      background-color: #28a745; /* Un verde brillante */
      border: 2px solid #ffffff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
      transform: scale(1.05); /* Lo hace un poco m√°s grande */
    }
  </style>
</head>

<body>
  <div id="hud" style="margin:8px 0;font-weight:600; font-size: 40px; display: flex; justify-content: center;">
    Puntos: &nbsp;<span id="score">0</span>
  </div>

  <div class="container" id="grid"></div>

  <div style="display: flex; justify-content: center; margin-top: 20px;">
    <button id="iniciar">Jugar con voz!</button>
    <button id="detener">Jugar sin voz</button>
  </div>

  <div id="winPopup">
    <div class="popup-content">
      <p>¬°Ganaste! üèÜ</p>
      <button onclick="location.reload()">Volver a jugar</button>
    </div>
  </div>

  <div id="losePopup">
    <div class="popup-content">
      <p>¬°Perdiste! üò¢</p>
      <button onclick="location.reload()">Volver a jugar</button>
    </div>
  </div>

  <!-- Audios -->
  <audio id="backgroundMusic" src="../sonidos/musica-fondo.mp3" autoplay loop>
  </audio>
  <audio id="moveSound" src="../sonidos/Cuackcorto.mp3" preload="auto"></audio>
  <audio id="winSound" src="../sonidos/victoria.mp3" preload="auto"></audio>
  <audio id="tronarSound" src="../sonidos/explosion.mp3" preload="auto"></audio>
  <audio id="aguilaSound" src="../sonidos/aguila.mp3" preload="auto"></audio>
  <audio id="alertaSound" loop src="../sonidos/alerta.mp3" preload="auto"></audio>
  <audio id="aguilaSalida" src="../sonidos/salida.mp3" preload="auto"></audio>
  <audio id="derrotaSound" src="../sonidos/derrota.mp3" preload="auto"></audio>
  <audio id="eatSound" src="../sonidos/clear-combo.mp3" preload="auto"></audio>
  <audio id="bumpSound" src="../sonidos/bump.mp3" preload="auto"></audio>

<script>
  const gridHeight = 10, gridWidth = 12;
  let score = 0;
  let crumb = null;
  let gameWon = false;
  let modoAlternativo = 0;

  if (modoAlternativo) {
    console.log("üåë Modo alternativo activado");
    document.body.style.backgroundImage = "url('./imagenes/el-malo.png')";
    document.getElementById('backgroundSource').src = "../sonidos/evilassmusic.mp3";
    document.getElementById('backgroundMusic').load();

    const estilo = document.createElement("style");
    estilo.innerHTML = `
      .player { background-image: url('./imagenes/evilassduck.png') !important; }
      .aguila { background-image: url('./imagenes/evilasseagle.png') !important; }
    `;
    document.head.appendChild(estilo);
  }

  window.addEventListener('load', () => {
    const grid = document.getElementById("grid");
    for (let y = 0; y < gridHeight; y++) {
      const row = document.createElement("div");
      row.className = 'row altura';
      for (let x = 0; x < gridWidth; x++) {
        const cell = document.createElement("div");
        cell.className = 'col-1 backgrounded bordered';
        cell.id = `cell-${y}-${x}`;
        cell.style.position = "relative";
        row.appendChild(cell);
      }
      grid.appendChild(row);
    }
    document.getElementById("cell-5-6").classList.add("player");
    spawnCrumb();
    setTimeout(aparecerAguila, 1000);
  });

  document.addEventListener('keydown', (e) => moverJugador(e.key));

  function reproducirPaso() {
    const moveSound = document.getElementById('moveSound');
    moveSound.pause();
    moveSound.currentTime = 0;
    moveSound.play().catch(() => {});
  }

  function moverJugador(tecla) {
    if (gameWon) return;
    const player = document.querySelector(".player");
    if (!player || player.classList.contains("pollo")) return;

    const [_, y, x] = player.id.split('-');
    let nextY = parseInt(y), nextX = parseInt(x);
    let dir = '';

    const invertido = modoAlternativo;
    switch (tecla) {
      case 'ArrowUp': nextY += invertido ? 1 : -1; dir = 'up'; break;
      case 'ArrowDown': nextY += invertido ? -1 : 1; dir = 'down'; break;
      case 'ArrowLeft': nextX += invertido ? 1 : -1; dir = 'left'; break;
      case 'ArrowRight': nextX += invertido ? -1 : 1; dir = 'right'; break;
      default: return;
    }

    if (nextX >= 0 && nextX < gridWidth && nextY >= 0 && nextY < gridHeight) {
      const nextCell = document.getElementById(`cell-${nextY}-${nextX}`);
      player.className = player.className.replace(/\bplayer\b.*$/, '');
      nextCell.classList.add('player', dir);
      reproducirPaso(); // sonido inmediato
      checkCrumbCollision();
    } else {
      document.getElementById('bumpSound').play();
    }
  }

  function spawnCrumb() {
    if (crumb) crumb.remove();
    let y, x;
    do {
      y = Math.floor(Math.random() * gridHeight);
      x = Math.floor(Math.random() * gridWidth);
    } while (document.getElementById(`cell-${y}-${x}`).classList.contains('player'));

    const cell = document.getElementById(`cell-${y}-${x}`);
    crumb = document.createElement("div");
    crumb.className = "crumb";
    cell.appendChild(crumb);
  }

  function checkCrumbCollision() {
    const player = document.querySelector('.player');
    if (!player || !crumb) return;

    if (player.contains(crumb)) {
      crumb.remove();
      crumb = null;

      if (modoAlternativo) {
        document.getElementById('derrotaSound').play();
        score--;
        document.getElementById('score').textContent = score;
        if (score <= -10) mostrarPopupPerder();
        else spawnCrumb();
      } else {
        document.getElementById('eatSound').play();
        score++;
        document.getElementById('score').textContent = score;
        if (score >= 10) winGame();
        else spawnCrumb();
      }
    }
  }

  function winGame() {
    gameWon = true;
    const player = document.querySelector('.player');
    const grid = document.getElementById('grid');

    const explosion = document.createElement('div');
    explosion.className = 'explosion';
    grid.appendChild(explosion);

    const rect = player.getBoundingClientRect();
    const gridRect = grid.getBoundingClientRect();
    explosion.style.top = (rect.top - gridRect.top - 20) + 'px';
    explosion.style.left = (rect.left - gridRect.left - 20) + 'px';

    document.getElementById('tronarSound').play();

    setTimeout(() => {
      explosion.remove();
      player.classList.add('pollo');
      document.getElementById('winSound').play();
      document.getElementById('winPopup').style.display = 'flex';
    }, 1000);
  }

  function aparecerAguila() {
    if (gameWon) return;
    const grid = document.getElementById('grid');
    const player = document.querySelector('.player');
    let playerY = 0; // Por defecto si el pato no se encuentra
    if (player) {
     playerY = parseInt(player.id.split('-')[1]);
    }

    // Calcula un rango de filas cerca del pato
    // -2 para incluir 2 arriba, +3 para incluir 2 abajo y la fila del pato
    let minRow = Math.max(0, playerY - 1);
    let maxRow = Math.min(gridHeight - 1, playerY + 2);

    // Si el pato est√° muy arriba (ej: fila 0), el rango ser√≠a 0,1,2.
    // Si est√° muy abajo (ej: fila 9), el rango ser√≠a 7,8,9.
    // Aseguramos que siempre haya un m√≠nimo de 3 filas en el rango si es posible
    if (maxRow - minRow < 2) {
      if (minRow === 0) maxRow = Math.min(gridHeight - 1, 2); // Si est√° arriba, coge 0,1,2
      else minRow = Math.max(0, gridHeight - 2); // Si est√° abajo, coge las √∫ltimas 2
    }

    // Elige una fila aleatoria dentro de ese rango
    const fila = Math.floor(Math.random() * (maxRow - minRow + 1)) + minRow;
    // --- FIN DE LA MODIFICACI√ìN ---
    const aguila = document.createElement('div');
    aguila.className = 'aguila';
    grid.appendChild(aguila);

    const rowHeight = document.querySelector('.altura').offsetHeight;
    const aguilaWidth = 70;
    const gridW = grid.offsetWidth;

    let derecha = Math.random() < 0.5;
    if (modoAlternativo) derecha = !derecha;

    let left = derecha ? gridW + aguilaWidth : -aguilaWidth;
    let step = derecha ? -8 : 8;
    aguila.style.transform = derecha ? "scaleX(1)" : "scaleX(-1)";
    aguila.style.top = (fila * rowHeight) + 'px';
    aguila.style.left = left + 'px';

    const sIn = modoAlternativo ? 'aguilaSalida' : 'aguilaSound';
    const sOut = modoAlternativo ? 'aguilaSound' : 'aguilaSalida';
    document.getElementById(sIn).play();

    const alertaSound = document.getElementById('alertaSound');
    let alertaActiva = false;

    const interval = setInterval(() => {
      if (gameWon) { clearInterval(interval); aguila.remove(); return; }
      left += step;
      aguila.style.left = left + 'px';

      const player = document.querySelector('.player');
      if (player) {
        const py = parseInt(player.id.split('-')[1]);
        // --- ALERTA ---
        if (py === fila && !alertaActiva) {
          alertaActiva = true;
          alertaSound.pause();
          alertaSound.currentTime = 0;
          alertaSound.play().catch(() => {});
        } else if (py !== fila && alertaActiva) {
          alertaActiva = false;
          alertaSound.pause();
        }

        // --- COLISI√ìN ---
        const playerRect = player.getBoundingClientRect();
        const aguilaRect = aguila.getBoundingClientRect();
        if (
          playerRect.left < aguilaRect.right &&
          playerRect.right > aguilaRect.left &&
          playerRect.top < aguilaRect.bottom &&
          playerRect.bottom > aguilaRect.top
        ) {
          clearInterval(interval);
          alertaSound.pause();
          aguila.remove();
          if (modoAlternativo) winGame();
          else mostrarPopupPerder();
        }
      }

      // --- Salida ---
      if ((derecha && left < -aguilaWidth) || (!derecha && left > gridW + aguilaWidth)) {
        clearInterval(interval);
        alertaSound.pause();
        document.getElementById(sOut).play();
        aguila.remove();
        if (!gameWon) setTimeout(aparecerAguila, 2000);
      }
    }, 60);
  }

  function mostrarPopupPerder() {
    gameWon = true;
    document.getElementById('backgroundMusic').pause();
    document.getElementById('derrotaSound').play();
    document.getElementById('losePopup').style.display = 'flex';
  }

  // --- VOZ --- //
  const iniciarBtn = document.getElementById('iniciar');
  const detenerBtn = document.getElementById('detener');
  let reconocimiento = null, activo = false;

  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    reconocimiento = new SpeechRecognition();
    reconocimiento.lang = 'es-MX';
    reconocimiento.continuous = false;
    reconocimiento.interimResults = false;

    // Por defecto, el modo "sin voz" est√° activo
    detenerBtn.classList.add('modo-activo');


    // --- REEMPLAZA TU FUNCI√ìN 'onclick' CON ESTA ---
    iniciarBtn.onclick = () => {
        if (!activo) {
            reconocimiento.start();
            activo = true;
        }
        // Actualiza el estilo visual
        iniciarBtn.classList.add('modo-activo');
        detenerBtn.classList.remove('modo-activo');
    };

    // --- REEMPLAZA TU FUNCI√ìN 'onclick' CON ESTA ---
    detenerBtn.onclick = () => {
        if (activo) {
            reconocimiento.stop();
            activo = false;
        }
        // Actualiza el estilo visual
        detenerBtn.classList.add('modo-activo');
        iniciarBtn.classList.remove('modo-activo');
    };

reconocimiento.onresult = (event) => {
    // Obtenemos la transcripci√≥n m√°s reciente y final
    const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();

    // Log para depurar (¬°muy √∫til!)
    console.log("Voz detectada:", transcript);

    const words = transcript.split(' ');

    for (const word of words) {
        // Mantenemos los 'if' separados. Esto est√° correcto.
        if (word.includes("arriba")) {
            moverJugador("ArrowUp");
        }
        if (word.includes("abajo")) {
            moverJugador("ArrowDown");
        }
        if (word.includes("izquierda")) {
            moverJugador("ArrowLeft");
        }
        if (word.includes("derecha")) {
            moverJugador("ArrowRight");
        }
    }
};

    reconocimiento.onend = () => {
    // Si el modo de voz sigue activo (no hemos presionado 'detener')
    // Y el juego no ha terminado (no hemos ganado o perdido),
    // volvemos a encender el micr√≥fono para el siguiente comando.
    if (activo && !gameWon) {
        reconocimiento.start();
    }
};
  }
</script>
</body>
</html>
